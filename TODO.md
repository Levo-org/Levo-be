# Levo Backend — 구현 작업 계획

> 마지막 업데이트: 2025-07-08

---

## ✅ Phase 1: 프로젝트 초기 설정 (기반 구축) — 완료

- [x] **1.1** Node.js + TypeScript 프로젝트 초기화
  - `package.json`, `tsconfig.json` 설정
  - 경로 alias 설정 (`@/models`, `@/services` 등)
- [x] **1.2** Express 앱 기본 구조 생성
  - `src/app.ts` — 미들웨어 체인 구성 (CORS, JSON 파서, 에러 핸들러)
  - `src/server.ts` — 서버 부트스트랩
- [x] **1.3** MongoDB 연결 설정
  - `src/config/database.ts` — Mongoose 연결
  - Docker Compose로 MongoDB 6.0 컨테이너 구성
  - `.env` 작성 완료
- [x] **1.4** 공통 유틸리티 작성
  - `ApiError` 커스텀 에러 클래스
  - `ApiResponse` 표준 응답 포맷 (`{ success, data, message, error }`)
  - 글로벌 에러 핸들러 미들웨어
- [x] **1.5** 요청 검증 미들웨어
- [x] **1.6** Swagger 문서 자동 생성 설정 (swagger-jsdoc + swagger-ui-express)

---

## ✅ Phase 2: 인증 시스템 — 완료

- [x] **2.1** User 모델 생성
- [x] **2.2** JWT 토큰 발급/검증 유틸
- [x] **2.3** Auth 미들웨어 (`req.user` 주입)
- [x] **2.4** Google OAuth 로그인 API
  - google-auth-library로 idToken 검증
  - 신규 유저 → 자동 회원가입
  - 기존 유저 → 로그인
- [x] **2.5** Apple OAuth 로그인 API
- [x] **2.6** Token 갱신 API (Refresh Token)
- [x] **2.7** 개발용 테스트 로그인 API (devLogin)
- [x] **2.8** Google 로그인 테스트 페이지 (`/auth-test`)

---

## ✅ Phase 3: 사용자 & 온보딩 — 완료

- [x] **3.1** UserLanguageProfile 모델 생성
- [x] **3.2** 온보딩 API
  - 언어 선택 + 레벨 선택 + 목표 설정 일괄 처리
  - UserLanguageProfile 자동 생성
  - UserStreak 자동 생성
  - UserProgress 자동 생성
- [x] **3.3** 프로필 조회/수정 API (getMe, updateMe)
- [x] **3.4** 설정 변경 API (updateSettings)
- [x] **3.5** 활성 언어 변경 API (changeLanguage)
  - 언어 변경 시 해당 언어 프로필이 없으면 새로 생성
  - 기존 언어 데이터는 보존

---

## ✅ Phase 4: 학습 콘텐츠 (CRUD + 시드 데이터) — 완료

### 콘텐츠 모델 생성
- [x] **4.1** Vocabulary 모델 + API (목록/상세/플래시카드/정답제출)
- [x] **4.2** Grammar 모델 + API (목록/상세/퀴즈/정답제출)
- [x] **4.3** Conversation 모델 + API (목록/상세/발음연습)
- [x] **4.4** Listening 모델 + API (목록/정답제출)
- [x] **4.5** Reading 모델 + API (목록/상세/퀴즈정답)

### 시드 데이터 스크립트
- [x] **4.6** 영어 단어 시드 (초급~중급, 140개)
- [x] **4.7** 영어 문법 시드 (32개+)
- [x] **4.8** 영어 회화 시드 (32개+)
- [x] **4.9** 영어 듣기 시드 (32개+)
- [x] **4.10** 영어 읽기 시드 (32개+)
- [x] **4.11** 일본어/중국어 시드 데이터 (모든 카테고리 × 3개 언어)
- [x] **4.12** 뱃지 시드 데이터 (40개)
- [x] **4.13** 레슨 시드 데이터 (영어/일본어/중국어 × 32개)
- [x] **4.14** 시드 실행 스크립트 (`npm run seed:clean`)

---

## ✅ Phase 5: 레슨 시스템 — 완료

- [x] **5.1** Lesson 모델 생성
- [x] **5.2** 레슨 맵 API (유닛별 목록 + 잠금 상태 계산)
- [x] **5.3** 레슨 시작 API (잠금 해제 여부 체크)
- [x] **5.4** 레슨 퀴즈 정답 제출 API
- [x] **5.5** 레슨 완료 API
  - XP 지급
  - 코인 지급
  - 다음 레슨 잠금 해제
  - 스트릭 업데이트
  - 레벨업 체크

---

## ✅ Phase 6: 카테고리별 학습 API — 완료

- [x] **6.1** 단어장 API (목록/상세/탭 필터 + 페이지네이션)
- [x] **6.2** 플래시카드 API (세트 조회 + 정답/오답 기록)
- [x] **6.3** 문법 API (목록/상세/퀴즈/정답제출)
- [x] **6.4** 회화 API (목록/대화문/발음 연습 기록)
- [x] **6.5** 듣기 API (문제 목록/정답 제출)
- [x] **6.6** 읽기 API (지문 목록/퀴즈 정답)
- [x] **6.7** 종합 퀴즈 API (오늘의 퀴즈 랜덤 생성 + 제출 + 완료)

---

## ✅ Phase 7: 게이미피케이션 — 완료

### 하트 시스템
- [x] **7.1** 하트 상태 조회 API (자동 충전 시간 동적 계산 포함)
- [x] **7.2** 하트 소모 로직 (오답 시 차감)
- [x] **7.3** 하트 충전 API (광고/코인/프리미엄)
- [x] **7.4** 30분 자동 충전 로직 (조회 시점 동적 계산)

### 스트릭
- [x] **7.5** UserStreak 모델 생성
- [x] **7.6** 스트릭 조회 API (현재/최장/주간 기록)
- [x] **7.7** 스트릭 업데이트 로직 (학습 완료 시 자동 — recordStudy)
- [x] **7.8** 스트릭 실드 사용 API
- [x] **7.9** KST 기준 스트릭 리셋/유지 로직

### 뱃지
- [x] **7.10** Badge 모델 + 시드 데이터 (40개)
- [x] **7.11** UserBadge 모델
- [x] **7.12** 뱃지 달성 체크 서비스 (checkAndAward 정적 메서드)
- [x] **7.13** 뱃지 목록 API (전체 + 획득 여부)

### 코인
- [x] **7.14** CoinTransaction 모델
- [x] **7.15** 코인 획득 API (광고/출석/초대)
- [x] **7.16** 코인 사용 API (하트/실드/힌트/프로필)
- [x] **7.17** 코인 잔액 + 거래 내역 API

---

## ✅ Phase 8: 복습 & 통계 — 완료

### 복습 시스템
- [x] **8.1** 복습 대시보드 API (카테고리별 복습 대기 수)
- [x] **8.2** 간격 반복 알고리즘 구현
  - 정답 시: 다음 복습 간격 증가 (1일 → 3일 → 7일 → 14일 → 30일 → 90일)
  - 오답 시: 간격 리셋 (1일로)
- [x] **8.3** 카테고리별 복습 항목 API (due items 조회)
- [x] **8.4** 복습 완료 기록 API

### 통계
- [x] **8.5** 학습 통계 API (주간/월간/전체)
- [x] **8.6** 카테고리별 학습 비율 계산
- [x] **8.7** 홈 화면 데이터 집계 API (HomeController)

---

## ✅ Phase 9: 구독 — 완료

- [x] **9.1** Subscription 모델
- [x] **9.2** 구독 상태 조회 API
- [x] **9.3** 구독 생성 API (plan + paymentProvider + transactionId)
- [x] **9.4** 구독 취소 API
- [ ] **9.5** Apple IAP / Google Play 영수증 서버 검증 (추후 실제 결제 연동 시)
- [ ] **9.6** 프리미엄 기능 게이팅 미들웨어 (추후)

---

## 📋 Phase 10: 알림 & 부가 기능 — 미구현

- [ ] **10.1** Firebase Cloud Messaging (FCM) 연동
- [ ] **10.2** 학습 알림 스케줄러 (cron)
- [ ] **10.3** 스트릭 위험 알림 (자정 2시간 전)
- [ ] **10.4** 하트 충전 완료 알림
- [x] **10.5** Rate Limiter 적용 ✅
- [ ] **10.6** 로깅 시스템 (Winston)

---

## 📋 Phase 11: 테스트 & 배포 — 미구현

- [ ] **11.1** Unit 테스트 (서비스 레이어)
- [ ] **11.2** Integration 테스트 (API 엔드포인트)
- [x] **11.3** Docker 설정 (docker-compose.yml — MongoDB) ✅
- [ ] **11.4** CI/CD 파이프라인 (GitHub Actions)
- [ ] **11.5** 프로덕션 배포

---

## 📊 구현 현황 요약

| Phase | 내용 | 상태 |
|-------|------|------|
| Phase 1 | 프로젝트 초기 설정 | ✅ 완료 |
| Phase 2 | 인증 시스템 | ✅ 완료 |
| Phase 3 | 사용자 & 온보딩 | ✅ 완료 |
| Phase 4 | 학습 콘텐츠 + 시드 | ✅ 완료 |
| Phase 5 | 레슨 시스템 | ✅ 완료 |
| Phase 6 | 카테고리별 학습 API | ✅ 완료 |
| Phase 7 | 게이미피케이션 | ✅ 완료 |
| Phase 8 | 복습 & 통계 | ✅ 완료 |
| Phase 9 | 구독 | ✅ 기본 완료 (결제 검증 미구현) |
| Phase 10 | 알림 & 부가 기능 | 🔲 미구현 |
| Phase 11 | 테스트 & 배포 | 🔲 미구현 |

---

## 🔗 접속 URL

| 서비스 | URL |
|--------|-----|
| API 서버 | `http://localhost:5001` |
| Swagger UI | `http://localhost:5001/api-docs` |
| 인증 테스트 | `http://localhost:5001/auth-test` |
| Health Check | `http://localhost:5001/health` |

---

## ⚠️ 잊지 말아야 할 핵심 포인트

### 🌍 언어 독립성
- **모든 콘텐츠 쿼리에 `targetLanguage` 필터를 반드시 포함**
- 사용자 진행도(UserProgress)는 언어별로 독립 도큐먼트
- 언어 변경 시 기존 데이터 절대 삭제하지 않음
- 새 언어 프로필 생성 시 초기값으로 세팅

### ❤️ 하트 자동 충전
- DB에 타이머를 저장하지 않음
- `lastHeartLostAt` 기반으로 **조회 시점에 동적 계산**
- 공식: `충전된 하트 수 = Math.floor((현재시간 - lastHeartLostAt) / 30분)`
- 최대 5개 초과하지 않도록 cap 처리

### 🔥 스트릭 리셋 판단
- 서버 시간 기준이 아닌 **KST(한국시간) 기준 자정**
- `lastStudyDate`가 어제가 아니고 오늘도 아니면 → 스트릭 리셋
- 스트릭 실드가 있으면 리셋 대신 실드 1개 소모

### 🎯 레슨 잠금 해제
- 선행 레슨(`prerequisiteLessonId`)이 `completedLessons`에 포함되어야 잠금 해제
- 첫 레슨은 `prerequisiteLessonId: null` → 항상 해제 상태

### 📊 간격 반복 알고리즘 (복습)
- SM-2 변형 사용
- 정답 연속 횟수에 따라 다음 복습 간격 증가
- 간격: 1일 → 3일 → 7일 → 14일 → 30일 → 90일
- 오답 시 1일로 리셋

### 💰 코인 트랜잭션
- 모든 코인 변동은 `CoinTransaction`에 기록 (감사 추적)
- `balanceAfter` 필드로 특정 시점 잔액 추적 가능
- User.coins와 트랜잭션 합계가 일치하도록 검증

---

## 📅 우선순위 요약

| 우선순위 | Phase | 설명 |
|---------|-------|------|
| 🔴 P0 | Phase 1~3 | 프로젝트 기반 + 인증 + 유저 (MVP 필수) |
| 🟠 P1 | Phase 4~5 | 학습 콘텐츠 + 레슨 시스템 (핵심 기능) |
| 🟡 P2 | Phase 6~7 | 카테고리 학습 + 게이미피케이션 |
| 🟢 P3 | Phase 8 | 복습 + 통계 |
| 🔵 P4 | Phase 9~10 | 구독/결제 + 알림 |
| ⚪ P5 | Phase 11 | 테스트 + 배포 |
