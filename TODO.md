# Levo Backend — 구현 작업 계획

> 마지막 업데이트: 2026-02-20

---

## 📋 Phase 1: 프로젝트 초기 설정 (기반 구축)

- [ ] **1.1** Node.js + TypeScript 프로젝트 초기화
  - `package.json`, `tsconfig.json` 설정
  - ESLint + Prettier 설정
  - 경로 alias 설정 (`@/models`, `@/services` 등)
- [ ] **1.2** Express 앱 기본 구조 생성
  - `src/app.ts` — 미들웨어 체인 구성 (CORS, JSON 파서, 에러 핸들러)
  - `src/server.ts` — 서버 부트스트랩
- [ ] **1.3** MongoDB 연결 설정
  - `src/config/database.ts` — Mongoose 연결
  - `.env.example` 작성
- [ ] **1.4** 공통 유틸리티 작성
  - `ApiError` 커스텀 에러 클래스
  - `ApiResponse` 표준 응답 포맷 (`{ success, data, message, error }`)
  - 글로벌 에러 핸들러 미들웨어
- [ ] **1.5** 요청 검증 미들웨어 (Joi 또는 Zod)
- [ ] **1.6** Swagger 문서 자동 생성 설정

---

## 📋 Phase 2: 인증 시스템

- [ ] **2.1** User 모델 생성
- [ ] **2.2** JWT 토큰 발급/검증 유틸
- [ ] **2.3** Auth 미들웨어 (`req.user` 주입)
- [ ] **2.4** Google OAuth 로그인 API
  - 클라이언트에서 받은 idToken 검증
  - 신규 유저 → 자동 회원가입
  - 기존 유저 → 로그인
- [ ] **2.5** Apple OAuth 로그인 API
- [ ] **2.6** Token 갱신 API (Refresh Token)
- [ ] **2.7** 로그아웃 API

---

## 📋 Phase 3: 사용자 & 온보딩

- [ ] **3.1** UserLanguageProfile 모델 생성
- [ ] **3.2** 온보딩 API
  - 언어 선택 + 레벨 선택 + 목표 설정 + 알림 설정 일괄 처리
  - UserLanguageProfile 자동 생성
  - UserStreak 자동 생성
  - UserProgress 자동 생성
- [ ] **3.3** 프로필 조회/수정 API
- [ ] **3.4** 설정 변경 API
- [ ] **3.5** 활성 언어 변경 API
  - 언어 변경 시 해당 언어 프로필이 없으면 새로 생성
  - 기존 언어 데이터는 보존

---

## 📋 Phase 4: 학습 콘텐츠 (CRUD + 시드 데이터)

### 콘텐츠 모델 생성
- [ ] **4.1** Vocabulary 모델 + CRUD
- [ ] **4.2** Grammar 모델 + CRUD
- [ ] **4.3** Conversation 모델 + CRUD
- [ ] **4.4** Listening 모델 + CRUD
- [ ] **4.5** Reading 모델 + CRUD

### 시드 데이터 스크립트
- [ ] **4.6** 영어 초급 단어 시드 (30개+)
- [ ] **4.7** 영어 초급 문법 시드 (5개+)
- [ ] **4.8** 영어 초급 회화 시드 (6개+)
- [ ] **4.9** 영어 초급 듣기 시드 (5개+)
- [ ] **4.10** 영어 초급 읽기 시드 (3개+)
- [ ] **4.11** 일본어/중국어 시드 데이터 (추후 확장)

> 💡 **중요**: 모든 시드 데이터에 `targetLanguage` 필드를 반드시 포함할 것

---

## 📋 Phase 5: 레슨 시스템

- [ ] **5.1** Lesson 모델 생성
- [ ] **5.2** 레슨 맵 API (유닛별 목록 + 잠금 상태 계산)
- [ ] **5.3** 레슨 시작 API
- [ ] **5.4** 레슨 퀴즈 정답 제출 API (하트 소모 연동)
- [ ] **5.5** 레슨 완료 API
  - XP 지급
  - 코인 지급
  - 다음 레슨 잠금 해제
  - 스트릭 업데이트
  - 뱃지 달성 체크

---

## 📋 Phase 6: 카테고리별 학습 API

- [ ] **6.1** 단어장 API (목록/상세/탭 필터)
- [ ] **6.2** 플래시카드 API (세트 조회 + 정답/오답 기록)
- [ ] **6.3** 문법 API (목록/상세/퀴즈)
- [ ] **6.4** 회화 API (목록/대화문/발음 연습)
- [ ] **6.5** 듣기 API (문제/정답 제출)
- [ ] **6.6** 읽기 API (지문/퀴즈)
- [ ] **6.7** 종합 퀴즈 API (오늘의 퀴즈 생성 로직)

---

## 📋 Phase 7: 게이미피케이션

### 하트 시스템
- [ ] **7.1** 하트 상태 조회 API (자동 충전 시간 계산 포함)
- [ ] **7.2** 하트 소모 로직 (오답 시 자동 연동)
- [ ] **7.3** 하트 충전 API (광고/코인/프리미엄)
- [ ] **7.4** 30분 자동 충전 로직 (조회 시 계산)

### 스트릭
- [ ] **7.5** UserStreak 모델 생성
- [ ] **7.6** 스트릭 조회 API (현재/최장/주간 기록)
- [ ] **7.7** 스트릭 업데이트 로직 (학습 완료 시 자동)
- [ ] **7.8** 스트릭 실드 사용 API
- [ ] **7.9** 자정 기준 스트릭 리셋 로직

### 뱃지
- [ ] **7.10** Badge 모델 + 시드 데이터
- [ ] **7.11** UserBadge 모델
- [ ] **7.12** 뱃지 달성 체크 서비스 (이벤트 기반)
- [ ] **7.13** 뱃지 목록 API (전체 + 획득 여부)

### 코인
- [ ] **7.14** CoinTransaction 모델
- [ ] **7.15** 코인 획득 API (광고/출석/초대)
- [ ] **7.16** 코인 사용 API (하트/실드/힌트/프로필)
- [ ] **7.17** 코인 거래 내역 API

---

## 📋 Phase 8: 복습 & 통계

### 복습 시스템
- [ ] **8.1** 복습 대시보드 API (카테고리별 현황)
- [ ] **8.2** 간격 반복 알고리즘 구현 (SM-2 변형)
  - 정답 시: 다음 복습 간격 증가 (1일 → 3일 → 7일 → 14일 → 30일)
  - 오답 시: 간격 리셋 (1일로)
- [ ] **8.3** 카테고리별 복습 항목 API
- [ ] **8.4** 복습 완료 기록 API

### 통계
- [ ] **8.5** 학습 통계 API (주간/월간/전체)
- [ ] **8.6** 카테고리별 학습 비율 계산
- [ ] **8.7** 주간 학습 차트 데이터 API

---

## 📋 Phase 9: 구독 & 결제

- [ ] **9.1** Subscription 모델
- [ ] **9.2** 구독 상태 조회 API
- [ ] **9.3** Apple IAP 영수증 검증
- [ ] **9.4** Google Play 영수증 검증
- [ ] **9.5** 프리미엄 기능 게이팅 미들웨어

---

## 📋 Phase 10: 알림 & 부가 기능

- [ ] **10.1** Firebase Cloud Messaging (FCM) 연동
- [ ] **10.2** 학습 알림 스케줄러 (cron)
- [ ] **10.3** 스트릭 위험 알림 (자정 2시간 전)
- [ ] **10.4** 하트 충전 완료 알림
- [ ] **10.5** Rate Limiter 적용
- [ ] **10.6** 로깅 시스템 (Winston)

---

## 📋 Phase 11: 테스트 & 배포

- [ ] **11.1** Unit 테스트 (서비스 레이어)
  - 하트 충전 로직 테스트
  - 스트릭 계산 테스트
  - XP/레벨 계산 테스트
  - 간격 반복 알고리즘 테스트
- [ ] **11.2** Integration 테스트 (API 엔드포인트)
- [ ] **11.3** Docker 설정 (Dockerfile + docker-compose)
- [ ] **11.4** CI/CD 파이프라인 (GitHub Actions)
- [ ] **11.5** 프로덕션 배포 (AWS / GCP / Railway 등)

---

## ⚠️ 잊지 말아야 할 핵심 포인트

### 🌍 언어 독립성
- **모든 콘텐츠 쿼리에 `targetLanguage` 필터를 반드시 포함**
- 사용자 진행도(UserProgress)는 언어별로 독립 도큐먼트
- 언어 변경 시 기존 데이터 절대 삭제하지 않음
- 새 언어 프로필 생성 시 초기값으로 세팅

### ❤️ 하트 자동 충전
- DB에 타이머를 저장하지 않음
- `lastHeartLostAt` 기반으로 **조회 시점에 동적 계산**
- 공식: `충전된 하트 수 = Math.floor((현재시간 - lastHeartLostAt) / 30분)`
- 최대 5개 초과하지 않도록 cap 처리

### 🔥 스트릭 리셋 판단
- 서버 시간 기준이 아닌 **KST(한국시간) 기준 자정**
- `lastStudyDate`가 어제가 아니고 오늘도 아니면 → 스트릭 리셋
- 스트릭 실드가 있으면 리셋 대신 실드 1개 소모

### 🎯 레슨 잠금 해제
- 선행 레슨(`prerequisiteLessonId`)이 `completedLessons`에 포함되어야 잠금 해제
- 첫 레슨은 `prerequisiteLessonId: null` → 항상 해제 상태

### 📊 간격 반복 알고리즘 (복습)
- SM-2 변형 사용
- 정답 연속 횟수에 따라 다음 복습 간격 증가
- 간격: 1일 → 3일 → 7일 → 14일 → 30일 → 90일
- 오답 시 1일로 리셋

### 💰 코인 트랜잭션
- 모든 코인 변동은 `CoinTransaction`에 기록 (감사 추적)
- `balanceAfter` 필드로 특정 시점 잔액 추적 가능
- User.coins와 트랜잭션 합계가 일치하도록 검증

---

## 📅 우선순위 요약

| 우선순위 | Phase | 설명 |
|---------|-------|------|
| 🔴 P0 | Phase 1~3 | 프로젝트 기반 + 인증 + 유저 (MVP 필수) |
| 🟠 P1 | Phase 4~5 | 학습 콘텐츠 + 레슨 시스템 (핵심 기능) |
| 🟡 P2 | Phase 6~7 | 카테고리 학습 + 게이미피케이션 |
| 🟢 P3 | Phase 8 | 복습 + 통계 |
| 🔵 P4 | Phase 9~10 | 구독/결제 + 알림 |
| ⚪ P5 | Phase 11 | 테스트 + 배포 |
